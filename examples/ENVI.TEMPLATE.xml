<?xml version="1.0" encoding="utf-8"?>
<ManagementPack ContentReadable="true" SchemaVersion="2.0" OriginalSchemaVersion="1.0" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
  <Manifest>
    <Identity>
      <ID>ENVI.TEMPLATE</ID>
      <Version>1.0.0.1</Version>
    </Identity>
    <Name>ENVI.TEMPLATE</Name>
    <References>
      <Reference Alias="Windows">
        <ID>Microsoft.Windows.Library</ID>
        <Version>7.5.8501.0</Version>
        <PublicKeyToken>31bf3856ad364e35</PublicKeyToken>
      </Reference>
      <Reference Alias="MicrosoftSystemCenterInstanceGroupLibrary7585010">
        <ID>Microsoft.SystemCenter.InstanceGroup.Library</ID>
        <Version>7.5.8501.0</Version>
        <PublicKeyToken>31bf3856ad364e35</PublicKeyToken>
      </Reference>
      <Reference Alias="System">
        <ID>System.Library</ID>
        <Version>7.5.8501.0</Version>
        <PublicKeyToken>31bf3856ad364e35</PublicKeyToken>
      </Reference>
      <Reference Alias="SC">
        <ID>Microsoft.SystemCenter.Library</ID>
        <Version>7.0.8432.0</Version>
        <PublicKeyToken>31bf3856ad364e35</PublicKeyToken>
      </Reference>
      <Reference Alias="Health">
        <ID>System.Health.Library</ID>
        <Version>7.0.8432.0</Version>
        <PublicKeyToken>31bf3856ad364e35</PublicKeyToken>
      </Reference>
    </References>
  </Manifest>
  <TypeDefinitions>
    <EntityTypes>
      <ClassTypes>
        <ClassType ID="ENVI.TEMPLATE.Class" Accessibility="Public" Abstract="false" Base="Windows!Microsoft.Windows.ComputerRole" Hosted="true" Singleton="false" Extension="false">
          <Property ID="Name" Type="string" AutoIncrement="false" Key="true" CaseSensitive="false" MaxLength="256" MinLength="0" Required="false" Scale="0" />
        </ClassType>
        <ClassType ID="ENVI.TEMPLATE.PROD" Accessibility="Public" Abstract="false" Base="ENVI.TEMPLATE.Class" Hosted="true" Singleton="false" Extension="false">
          <Property ID="Site" Type="string" AutoIncrement="false" Key="false" CaseSensitive="false" MaxLength="256" MinLength="0" Required="false" Scale="0" />
        </ClassType>
        <ClassType ID="ENVI.TEMPLATE.PROD.Group" Accessibility="Public" Abstract="false" Base="MicrosoftSystemCenterInstanceGroupLibrary7585010!Microsoft.SystemCenter.InstanceGroup" Hosted="false" Singleton="true" Extension="false" />
        <ClassType ID="ENVI.TEMPLATE.Group" Accessibility="Public" Abstract="false" Base="MicrosoftSystemCenterInstanceGroupLibrary7585010!Microsoft.SystemCenter.InstanceGroup" Hosted="false" Singleton="true" Extension="false" />
      </ClassTypes>
    </EntityTypes>
  </TypeDefinitions>
  <Monitoring>
    <Discoveries>
      <Discovery ID="ENVI.TEMPLATE.MAIN.DISCOVERY" Enabled="true" Target="SC!Microsoft.SystemCenter.RootManagementServer" ConfirmDelivery="true" Remotable="true" Priority="Normal">
        <Category>Discovery</Category>
        <DiscoveryTypes>
          <DiscoveryClass TypeID="ENVI.TEMPLATE.Class">
            <Property TypeID="ENVI.TEMPLATE.Class" PropertyID="Name" />
            <Property TypeID="System!System.Entity" PropertyID="DisplayName" />
          </DiscoveryClass>
        </DiscoveryTypes>
        <DataSource ID="DS" TypeID="Windows!Microsoft.Windows.TimedPowerShell.DiscoveryProvider">
          <IntervalSeconds>3600</IntervalSeconds>
          <SyncTime />
          <ScriptName>TEMPLATEDiscovery.ps1</ScriptName>
          <ScriptBody>Param($SourceID,$ManagedEntityId)
Import-Module "operationsmanager"
New-SCOMManagementGroupConnection -ComputerName localhost
#Discovery Proprty Bag
$api = New-Object -ComObject 'MOM.ScriptAPI'
$Discovery = $api.CreateDiscoveryData( 0, $SourceID, $ManagedEntityId)
#Get Application Groups
$Groups = get-scomgroup -displayname "ENVI_TEMPLATE_*" | ? {$_.displayname -like "*PROD" }

foreach ($Group in $Groups)
{

    $Servers = $Group.GetRelatedMonitoringObjects()
    
    foreach ($Server in $Servers)
                {
                    $Name = Get-SCOMClass -name "Microsoft.Windows.Computer" | Get-SCOMClassInstance | ? {$_.name -like $Server.Name -and $_.name -ne $null} | Select-Object -ExpandProperty *.DNSName
                    $ServerName = $Name.value
                    if($ServerName -ne $null)
                    {
                    $AppInstance = $Discovery.CreateClassInstance("$MPElement[Name='ENVI.TEMPLATE.Class']$")
                    $AppInstance.AddProperty("$MPElement[Name='System!System.Entity']/DisplayName$","ENVI TEMPLATE")
                    $AppInstance.AddProperty("$MPElement[Name='Windows!Microsoft.Windows.Computer']/PrincipalName$",$ServerName)
                    $AppInstance.AddProperty("$MPElement[Name='ENVI.TEMPLATE.Class']/Name$","ENVI TEMPLATE")
                    $Discovery.AddInstance($AppInstance)

                    if ($Group.DisplayName -like "*PROD")
                        {
                         $AppInstancePROD = $Discovery.CreateClassInstance("$MPElement[Name='ENVI.TEMPLATE.PROD']$")
                         $AppInstancePROD.AddProperty("$MPElement[Name='System!System.Entity']/DisplayName$","ENVI TEMPLATE PROD")
                         $AppInstancePROD.AddProperty("$MPElement[Name='Windows!Microsoft.Windows.Computer']/PrincipalName$",$ServerName)
                         $AppInstancePROD.AddProperty("$MPElement[Name='ENVI.TEMPLATE.PROD']/Site$","PROD")
                         $AppInstancePROD.AddProperty("$MPElement[Name='ENVI.TEMPLATE.Class']/Name$","ENVI TEMPLATE")
                         $Discovery.AddInstance($AppInstancePROD)
                        }

                    Write-EventLog -LogName 'Operations Manager' -EventId 556 -Message $ServerName -Source "HealthService"
                    write-host $Name -ForegroundColor Red
                    }
                }
}



Write-EventLog -LogName 'Operations Manager' -EventId 556 -Message "DONE" -Source "HealthService"

$Discovery</ScriptBody>
          <Parameters>
            <Parameter>
              <Name>SourceID</Name>
              <Value>$MPElement$</Value>
            </Parameter>
            <Parameter>
              <Name>ManagedEntityId</Name>
              <Value>$Target/Id$</Value>
            </Parameter>
          </Parameters>
          <TimeoutSeconds>120</TimeoutSeconds>
        </DataSource>
      </Discovery>
      <Discovery ID="ENVI.TEMPLATE.PROD.Group.DiscoveryRule" Enabled="true" Target="ENVI.TEMPLATE.PROD.Group" ConfirmDelivery="false" Remotable="true" Priority="Normal">
        <Category>Discovery</Category>
        <DiscoveryTypes>
          <DiscoveryRelationship TypeID="MicrosoftSystemCenterInstanceGroupLibrary7585010!Microsoft.SystemCenter.InstanceGroupContainsEntities" />
        </DiscoveryTypes>
        <DataSource ID="GroupPopulationDataSource" TypeID="SC!Microsoft.SystemCenter.GroupPopulator">
          <RuleId>$MPElement$</RuleId>
          <GroupInstanceId>$MPElement[Name="ENVI.TEMPLATE.PROD.Group"]$</GroupInstanceId>
          <MembershipRules>
            <MembershipRule Comment="EMPTY_RULE_8eadaced-59c8-4ebc-a4e4-b8428a374442">
              <MonitoringClass>$MPElement[Name="System!System.Entity"]$</MonitoringClass>
              <RelationshipClass>$MPElement[Name="MicrosoftSystemCenterInstanceGroupLibrary7585010!Microsoft.SystemCenter.InstanceGroupContainsEntities"]$</RelationshipClass>
              <Expression>
                <SimpleExpression>
                  <ValueExpression>
                    <Value>True</Value>
                  </ValueExpression>
                  <Operator>Equal</Operator>
                  <ValueExpression>
                    <Value>False</Value>
                  </ValueExpression>
                </SimpleExpression>
              </Expression>
            </MembershipRule>
          </MembershipRules>
        </DataSource>
      </Discovery>
      <Discovery ID="ENVI.TEMPLATE.Group.DiscoveryRule" Enabled="true" Target="ENVI.TEMPLATE.Group" ConfirmDelivery="false" Remotable="true" Priority="Normal">
        <Category>Discovery</Category>
        <DiscoveryTypes>
          <DiscoveryRelationship TypeID="MicrosoftSystemCenterInstanceGroupLibrary7585010!Microsoft.SystemCenter.InstanceGroupContainsEntities" />
        </DiscoveryTypes>
        <DataSource ID="GroupPopulationDataSource" TypeID="SC!Microsoft.SystemCenter.GroupPopulator">
          <RuleId>$MPElement$</RuleId>
          <GroupInstanceId>$MPElement[Name="ENVI.TEMPLATE.Group"]$</GroupInstanceId>
          <MembershipRules>
            <MembershipRule>
              <MonitoringClass>$MPElement[Name="ENVI.TEMPLATE.PROD.Group"]$</MonitoringClass>
              <RelationshipClass>$MPElement[Name="MicrosoftSystemCenterInstanceGroupLibrary7585010!Microsoft.SystemCenter.InstanceGroupContainsEntities"]$</RelationshipClass>
            </MembershipRule>
          </MembershipRules>
        </DataSource>
      </Discovery>
    </Discoveries>
  </Monitoring>
  <LanguagePacks>
    <LanguagePack ID="ENU" IsDefault="true">
      <DisplayStrings>
        <DisplayString ElementID="ENVI.TEMPLATE">
          <Name>ENVI TEMPLATE</Name>
        </DisplayString>
        <DisplayString ElementID="ENVI.TEMPLATE.Class">
          <Name>ENVI TEMPLATE</Name>
          <Description>ENVI Application Main Class</Description>
        </DisplayString>
        <DisplayString ElementID="ENVI.TEMPLATE.MAIN.DISCOVERY">
          <Name>ENVI TEMPLATE Main Discovery</Name>
        </DisplayString>
        <DisplayString ElementID="ENVI.TEMPLATE.PROD">
          <Name>ENVI TEMPLATE PROD</Name>
          <Description>ENVI Application PROD Class</Description>
        </DisplayString>
        <DisplayString ElementID="ENVI.TEMPLATE.PROD.Group">
          <Name>ENVI_TEMPLATE_PROD</Name>
          <Description>ENVI Application PROD Group</Description>
        </DisplayString>
        <DisplayString ElementID="ENVI.TEMPLATE.PROD.Group.DiscoveryRule">
          <Name>Populate ENVI TEMPLATE PROD</Name>
          <Description>This discovery rule populates the group 'ENVI TEMPLATE:PROD'</Description>
        </DisplayString>
        <DisplayString ElementID="ENVI.TEMPLATE.Group">
          <Name>ENVI_TEMPLATE_Group</Name>
          <Description>ENVI Application Main Group</Description>
        </DisplayString>
        <DisplayString ElementID="ENVI.TEMPLATE.Group.DiscoveryRule">
          <Name>Populate ENVI TEMPLATE Group</Name>
          <Description>This discovery rule populates the group 'ENVI TEMPLATE Group'</Description>
        </DisplayString>
        <DisplayString ElementID="ENVI.TEMPLATE.Class" SubElementID="Name">
          <Name>Application Name</Name>
        </DisplayString>
        <DisplayString ElementID="ENVI.TEMPLATE.PROD" SubElementID="Site">
          <Name>Site</Name>
        </DisplayString>
      </DisplayStrings>
    </LanguagePack>
  </LanguagePacks>
</ManagementPack>